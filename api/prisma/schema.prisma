generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ExperienceLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum Goal {
  WEIGHT_LOSS
  MUSCLE_GAIN
  ENDURANCE
  MAINTENANCE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ProgramStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
  DRAFT
}

enum FriendStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

enum GroupStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

enum RequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum ExerciceType {
  COMPOUND
  ISOLATION
  CARDIO
  MOBILITY
  STRETCH
}

enum ProgramTemplate {
  FULL_BODY
  PUSH_PULL_LEGS
  UPPER_LOWER
  UPPER_LOWER_UPPER_LOWER
  UPPER_LOWER_PUSH_PULL
  PUSH_PULL_LEGS_UPPER_LOWER
  PUSH_PULL_LEGS_PUSH_PULL_LEGS
  PUSH_PULL_LEGS_CARDIO
  CUSTOM
}

enum ConversationType {
  PRIVATE
  GROUP
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  FILE
}

model User {
  id                Int      @id @default(autoincrement())
  name              String
  email             String   @unique
  password          String
  profilePictureUrl String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt
  refreshToken      String?
  resetPasswordCode    String?
  resetPasswordExpires DateTime?
  
  // Email verification
  emailVerified             Boolean   @default(false)
  emailVerificationCode     String?
  emailVerificationExpires  DateTime?

  fitnessProfiles  FitnessProfile[]
  exercicesCreated Exercice[]       @relation("ExerciceCreatedBy")

  // Relations sociales
  friends               Friend[]             @relation("UserFriends")
  friendsOf             Friend[]             @relation("UserFriendsReverse")
  sentRequests          FriendRequest[]      @relation("SentRequests")
  receivedRequests      FriendRequest[]      @relation("ReceivedRequests")
  groups                FriendGroup[]        @relation("GroupMembers")
  adminOfGroups         FriendGroup[]        @relation("GroupAdmin")
  sentGroupRequests     FriendGroupRequest[] @relation("SentGroupRequests")
  receivedGroupRequests FriendGroupRequest[] @relation("ReceivedGroupRequests")

  // Relations chat
  conversationParticipants ConversationParticipant[]
  messages                 Message[]
  messageReactions         MessageReaction[]

  sessionPhotos SessionPhoto[]

  // Relations Shared Sessions
  organizedSessions     SharedSession[]            @relation("OrganizedSessions")
  participatingSessions SharedSessionParticipant[]
  SharedSession         SharedSession[]
}

enum WeekDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
  CUSTOM
}

model FitnessProfile {
  id                Int             @id @default(autoincrement())
  userId            Int             @unique
  age               Int
  height            Float
  weight            Float
  trainingFrequency Int
  experienceLevel   ExperienceLevel
  goals             Goal[]
  gender            Gender
  bodyWeight        Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @default(now()) @updatedAt

  weightHistory    WeightHistory[]
  trainingPrograms TrainingProgram[]
  trainingDays     WeekDay[]

  user User @relation(fields: [userId], references: [id])
}

model WeightHistory {
  id               Int      @id @default(autoincrement())
  fitnessProfileId Int
  weight           Float
  date             DateTime @default(now())

  fitnessProfile FitnessProfile @relation(fields: [fitnessProfileId], references: [id], onDelete: Cascade)
}

model TrainingProgram {
  id               Int               @id @default(autoincrement())
  fitnessProfileId Int
  name             String
  description      String?
  startDate        DateTime          @default(now())
  template         ProgramTemplate?
  status           ProgramStatus     @default(DRAFT)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @default(now()) @updatedAt
  sessions         TrainingSession[]

  fitnessProfile FitnessProfile @relation(fields: [fitnessProfileId], references: [id], onDelete: Cascade)
}

model TrainingSession {
  id                Int       @id @default(autoincrement())
  programId         Int
  date              DateTime?
  performedAt       DateTime?
  duration          Int?
  notes             String?
  originalSessionId Int?
  completed         Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now()) @updatedAt

  exercices       ExerciceSession[]
  trainingProgram TrainingProgram   @relation(fields: [programId], references: [id], onDelete: Cascade)

  sessionPhotos            SessionPhoto[]
  SharedSession            SharedSession[]
  SharedSessionParticipant SharedSessionParticipant[]
}

model SessionPhoto {
  id          Int      @id @default(autoincrement())
  sessionId   Int
  userId      Int
  photoUrl    String
  createdAt   DateTime @default(now())
  description String?

  session TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Exercice {
  id              Int           @id @default(autoincrement())
  name            String
  difficulty      Int
  description     String?
  type            ExerciceType?
  Materials       Boolean       @default(false)
  bodyWeight      Boolean       @default(false)
  isDefault       Boolean       @default(false)
  createdByUserId Int?
  imageUrl        String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @default(now()) @updatedAt

  groupes         ExerciceMuscleGroup[]
  trainingSession ExerciceSession[]
  equipments      ExerciceEquipment[]
  createdBy       User?                 @relation("ExerciceCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)
}

model ExerciceSession {
  id         Int    @id @default(autoincrement())
  sessionId  Int
  exerciceId Int
  sets       Int
  reps       Int
  weight     Float?

  trainingSession TrainingSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  exercice        Exercice         @relation(fields: [exerciceId], references: [id], onDelete: Cascade)
  performances    SetPerformance[]

  @@unique([sessionId, exerciceId])
}

model SetPerformance {
  id_set              Int      @id @default(autoincrement())
  id_exercice_session Int
  set_index           Int
  reps_effectuees     Int?
  reps_prevues        Int?
  weight              Float?
  rpe                 Int?
  success             Boolean? @default(true)

  exerciceSession ExerciceSession @relation(fields: [id_exercice_session], references: [id], onDelete: Cascade)
}

model ExerciceMuscleGroup {
  exerciceId Int
  groupeId   Int

  exercice Exercice    @relation(fields: [exerciceId], references: [id], onDelete: Cascade)
  groupe   MuscleGroup @relation(fields: [groupeId], references: [id], onDelete: Cascade)

  @@id([exerciceId, groupeId])
}

model MuscleGroup {
  id        Int                   @id @default(autoincrement())
  name      String                @unique
  exercices ExerciceMuscleGroup[]
}

model Equipment {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  exercices ExerciceEquipment[]
}

model ExerciceEquipment {
  exerciceId  Int
  equipmentId Int

  exercice  Exercice  @relation(fields: [exerciceId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@id([exerciceId, equipmentId])
}

model Friend {
  id       Int          @id @default(autoincrement())
  userId   Int
  friendId Int
  status   FriendStatus @default(ACCEPTED)

  user   User @relation("UserFriends", fields: [userId], references: [id])
  friend User @relation("UserFriendsReverse", fields: [friendId], references: [id])

  @@unique([userId, friendId])
}

model FriendRequest {
  id         String        @id @default(uuid())
  senderId   Int
  receiverId Int
  status     RequestStatus @default(PENDING)
  createdAt  DateTime      @default(now())

  sender   User @relation("SentRequests", fields: [senderId], references: [id])
  receiver User @relation("ReceivedRequests", fields: [receiverId], references: [id])

  @@unique([senderId, receiverId])
}

model FriendGroup {
  id        Int      @id @default(autoincrement())
  name      String
  adminId   Int?     
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members User[] @relation("GroupMembers")
  admin   User?  @relation("GroupAdmin", fields: [adminId], references: [id])

  joinRequests   FriendGroupRequest[] @relation("GroupJoinRequests")
  conversations  Conversation[]
  sharedSessions SharedSession[]
}

model FriendGroupRequest {
  id         String      @id @default(uuid())
  senderId   Int
  receiverId Int
  groupId    Int
  status     GroupStatus @default(PENDING)
  createdAt  DateTime    @default(now())

  sender   User        @relation("SentGroupRequests", fields: [senderId], references: [id])
  group    FriendGroup @relation("GroupJoinRequests", fields: [groupId], references: [id])
  receiver User        @relation("ReceivedGroupRequests", fields: [receiverId], references: [id])

  @@unique([senderId, groupId])
}

model Conversation {
  id        String           @id @default(uuid())
  type      ConversationType
  groupId   Int?
  name      String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  participants ConversationParticipant[]
  messages     Message[]
  group        FriendGroup?              @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([groupId])
}

model ConversationParticipant {
  id             String   @id @default(uuid())
  conversationId String
  userId         Int
  joinedAt       DateTime @default(now())
  lastReadAt     DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String      @id @default(uuid())
  conversationId String
  senderId       Int
  content        String      @db.Text
  type           MessageType @default(TEXT)
  mediaUrl       String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  isEdited       Boolean     @default(false)
  isDeleted      Boolean     @default(false)

  conversation Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User              @relation(fields: [senderId], references: [id], onDelete: Cascade)
  reactions    MessageReaction[]

  @@index([conversationId, createdAt])
  @@index([senderId])
}

model MessageReaction {
  id        String   @id @default(uuid())
  messageId String
  userId    Int
  emoji     String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

model SharedSession {
  id              String   @id @default(uuid())
  title           String
  description     String?
  startTime       DateTime
  location        String?  @default("Gym")
  maxParticipants Int? // Null = illimité
  organizerId     Int
  groupId         Int? // Optionnel : si lié à un groupe spécifique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizer         User                       @relation("OrganizedSessions", fields: [organizerId], references: [id], onDelete: Cascade)
  group             FriendGroup?               @relation(fields: [groupId], references: [id], onDelete: Cascade)
  participants      SharedSessionParticipant[]
  User              User?                      @relation(fields: [userId], references: [id])
  userId            Int?
  TrainingSession   TrainingSession?           @relation(fields: [trainingSessionId], references: [id])
  trainingSessionId Int?

  @@index([organizerId])
  @@index([groupId])
  @@index([startTime])
}

model SharedSessionParticipant {
  id              String   @id @default(uuid())
  sharedSessionId String
  userId          Int
  joinedAt        DateTime @default(now())

  sharedSession     SharedSession    @relation(fields: [sharedSessionId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  TrainingSession   TrainingSession? @relation(fields: [trainingSessionId], references: [id])
  trainingSessionId Int?

  @@unique([sharedSessionId, userId])
  @@index([userId])
}
